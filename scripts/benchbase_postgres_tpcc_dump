#!/bin/bash
set -eu

PG_CONTAINER_NAME="my-postgres"
PG_PASSWORD="mysecretpassword"
PG_PORT=5432

DUMP_FILE="benchbase-run-$(date +%Y%m%d%H%M%S).pcap"
BENCHBASE_CMD="benchbase -b tpcc -c config/postgres/sample_postgres_config.xml --execute=true"

echo "Starting PostgreSQL Docker container..."
docker run --name $PG_CONTAINER_NAME \
  -e POSTGRES_PASSWORD=$PG_PASSWORD \
  -p $PG_PORT:5432 \
  -d postgres

echo "Waiting for PostgreSQL to be ready..."
sleep 10

echo "Starting tcpdump on port $PG_PORT..."
sudo tcpdump -i lo port $PG_PORT -w $DUMP_FILE &
TCPDUMP_PID=$!

echo "Running Benchbase TPC-C benchmark..."
$BENCHBASE_CMD

echo "Stopping tcpdump..."
sudo kill $TCPDUMP_PID

echo "Stopping and removing PostgreSQL Docker container..."
docker stop $PG_CONTAINER_NAME
docker rm $PG_CONTAINER_NAME

echo "Done! TCP dump saved as $DUMP_FILE"
